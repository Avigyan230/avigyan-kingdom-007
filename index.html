<!-- Full HTML for Avigyan Kingdom game with Firebase, leaderboard, game over animation, and error handling -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avigyan Kingdom</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #fefcea, #f1da36);
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2.5em;
      color: #6b4e14;
      margin: 20px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
    }
    button {
      background: #ffcc00;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #timer {
      font-size: 1.2em;
      margin: 10px;
      color: #b22222;
    }
    #gameArea {
      height: 300px;
      position: relative;
      background: #fff3cd;
      margin: 20px auto;
      width: 300px;
      overflow: hidden;
    }
    .poop {
      position: absolute;
      top: 0;
      font-size: 24px;
    }
    #playAgainBtn {
      display: none;
      margin-top: 15px;
    }
    .leaderboard-table {
      margin: 20px auto;
      width: 60%;
      border-collapse: collapse;
    }
    .leaderboard-table th, .leaderboard-table td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    .gold { background: gold; }
    .silver { background: silver; }
    .bronze { background: #cd7f32; }
    #gameOverMsg {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2em;
      color: #b22222;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px #999;
      display: none;
      z-index: 10;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      getDocs,
      collection
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD-xD6K9L-y2vTLKStArK4NFG3ZgzBE62I",
      authDomain: "avigyan-kingdom.firebaseapp.com",
      projectId: "avigyan-kingdom",
      storageBucket: "avigyan-kingdom.appspot.com",
      messagingSenderId: "201196096111",
      appId: "1:201196096111:web:0d10f2a385efb021cf4201"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const users = {
      piku: "dhiku",
      chotu: "gadha",
      mam: "goru",
      gunja: "hagu",
      avigyan: "king"
    };

    let currentUser = "";

    function login() {
      const u = document.getElementById("username").value.toLowerCase();
      const p = document.getElementById("password").value.toLowerCase();
      if (users[u] === p) {
        currentUser = u;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("gameBox").style.display = "block";
        document.getElementById("playerName").innerText = u;
        showLeaderboards();
      } else {
        document.getElementById("error").innerText = "Wrong credentials!";
      }
    }

    async function showLeaderboards() {
      const today = new Date().toISOString().slice(0, 10);
      const totalRef = collection(db, "scores");
      const dailyRef = collection(db, `daily-${today}`);

      const totalSnap = await getDocs(totalRef);
      const dailySnap = await getDocs(dailyRef);

      const totalData = [];
      totalSnap.forEach(doc => totalData.push([doc.id, doc.data().total]));
      const dailyData = [];
      dailySnap.forEach(doc => dailyData.push([doc.id, doc.data().score]));

      totalData.sort((a, b) => b[1] - a[1]);
      dailyData.sort((a, b) => b[1] - a[1]);

      const totalRows = document.querySelector("#totalBoard tbody");
      totalRows.innerHTML = "";
      totalData.forEach(([name, score], i) => {
        const tr = document.createElement("tr");
        if (i === 0) tr.classList.add("gold");
        if (i === 1) tr.classList.add("silver");
        if (i === 2) tr.classList.add("bronze");
        tr.innerHTML = `<td>${i + 1}</td><td>${name}</td><td>${score.toFixed(1)}</td>`;
        totalRows.appendChild(tr);
      });

      const dailyRows = document.querySelector("#dailyBoard tbody");
      dailyRows.innerHTML = "";
      dailyData.forEach(([name, score], i) => {
        const tr = document.createElement("tr");
        if (i === 0) tr.classList.add("gold");
        if (i === 1) tr.classList.add("silver");
        if (i === 2) tr.classList.add("bronze");
        tr.innerHTML = `<td>${i + 1}</td><td>${name}</td><td>${score.toFixed(1)}</td>`;
        dailyRows.appendChild(tr);
      });
    }

    function startGame() {
      const diff = document.getElementById("difficulty").value;
      const gameArea = document.getElementById("gameArea");
      const scoreDisplay = document.getElementById("scoreDisplay");
      const timerDisplay = document.getElementById("timer");
      const playAgain = document.getElementById("playAgainBtn");
      const points = { easy: 1, medium: 1.5, hard: 2 }[diff];
      const speed = { easy: 60, medium: 40, hard: 25 }[diff];
      const rate = { easy: 1000, medium: 700, hard: 400 }[diff];

      let score = 0;
      let missed = 0;
      let time = 30;

      gameArea.innerHTML = '';
      const gameOverMsg = document.createElement("div");
      gameOverMsg.id = "gameOverMsg";
      gameOverMsg.textContent = "üíÄ Game Over! üíÄ";
      gameArea.appendChild(gameOverMsg);
      gameOverMsg.style.display = "none";

      scoreDisplay.textContent = "Score: 0";
      timerDisplay.textContent = `‚è≥ Time left: ${time}s`;
      playAgain.style.display = "none";

      const gameTimer = setInterval(() => {
        time--;
        timerDisplay.textContent = `‚è≥ Time left: ${time}s`;
        if (time <= 0) end();
      }, 1000);

      const dropInterval = setInterval(() => {
        if (missed < 3 && time > 0) drop();
      }, rate);

      function drop() {
        const poop = document.createElement("div");
        poop.className = "poop";
        poop.textContent = "üí©";
        poop.style.left = Math.random() * 90 + "%";
        gameArea.appendChild(poop);
        let pos = 0;

        const fall = setInterval(() => {
          if (pos >= 270) {
            clearInterval(fall);
            poop.remove();
            missed++;
            if (missed >= 3) end();
          } else {
            pos += 5;
            poop.style.top = pos + "px";
          }
        }, speed);

        poop.onclick = () => {
          clearInterval(fall);
          poop.remove();
          score += points;
          scoreDisplay.textContent = `Score: ${score.toFixed(1)}`;
        };
      }

      async function end() {
        clearInterval(gameTimer);
        clearInterval(dropInterval);
        gameOverMsg.style.display = "block";
        playAgain.style.display = "inline-block";

        try {
          const now = new Date();
          const today = now.toISOString().slice(0, 10);
          const uRef = doc(db, "scores", currentUser);
          const snap = await getDoc(uRef);
          const prev = snap.exists() ? snap.data().total : 0;
          await setDoc(uRef, {
            total: prev + score,
            lastPlayed: now.toISOString()
          });
          const dRef = doc(db, `daily-${today}`, currentUser);
          await setDoc(dRef, {
            score,
            time: now.toISOString()
          });
          showLeaderboards();
        } catch (err) {
          console.error("Error saving scores:", err);
          alert("‚ö†Ô∏è Failed to save score. Check your connection or try again.");
        }
      }
    }

    window.login = login;
    window.startGame = startGame;
  </script>
</head>
<body>
  <h1>üè∞ Welcome to Avigyan Kingdom üè∞</h1>
  <div id="loginBox">
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="error" style="color:red"></p>
  </div>
  <div id="gameBox" style="display:none">
    <h2>Welcome, <span id="playerName"></span>!</h2>
    <p>üéØ Task: Tap falling poops!</p>
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button onclick="startGame()">Start Game</button>
    <div id="timer"></div>
    <div id="scoreDisplay">Score: 0</div>
    <div id="gameArea"></div>
    <button id="playAgainBtn" onclick="startGame()">Play Again</button>
    <h3>üèÜ All-Time Leaderboard</h3>
    <table class="leaderboard-table" id="totalBoard">
      <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
      <tbody></tbody>
    </table>
    <h3>üéâ Today's Top Scorer</h3>
    <table class="leaderboard-table" id="dailyBoard">
      <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>


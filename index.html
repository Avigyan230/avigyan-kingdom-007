<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avigyan Kingdom</title>
  <style>
    body { font-family:'Segoe UI',sans-serif; background:linear-gradient(to bottom,#fefcea,#f1da36); text-align:center; margin:0; padding:0;}
    h1{font-size:2.5em;color:#6b4e14;margin:20px;}
    input,select,button{padding:8px;margin:5px;}
    button{background:#ffcc00;border:none;border-radius:5px;cursor:pointer;font-weight:bold;}
    #timer{font-size:1.2em;margin:10px;color:#b22222;}
    #gameArea{height:300px;position:relative;background:#fff3cd;margin:20px auto;width:300px;overflow:hidden;}
    .poop{position:absolute;top:0;font-size:24px;}
    #playAgainBtn{display:none;margin-top:15px;}
    .leaderboard-table{margin:20px auto;width:60%;border-collapse:collapse;}
    .leaderboard-table th,.leaderboard-table td{border:1px solid #ccc;padding:10px;}
    .gold{background:gold;} .silver{background:silver;} .bronze{background:#cd7f32;}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyD-xD6K9L-y2vTLKStArK4NFG3ZgzBE62I",
      authDomain: "avigyan-kingdom.firebaseapp.com",
      projectId: "avigyan-kingdom",
      storageBucket: "avigyan-kingdom.appspot.com",
      messagingSenderId: "201196096111",
      appId: "1:201196096111:web:0d10f2a385efb021cf4201"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const users = { piku:'dhiku', chotu:'gadha', mam:'goru', gunja:'hagu', avigyan:'king' };
    let currentUser = "";

    async function showTotalLeaderboard(){
      const rows = document.querySelector("#totalBoard tbody"); rows.innerHTML="";
      let arr = [];
      const snap = await getDocs(collection(db, "scores"));
      snap.forEach(d => arr.push([d.id, d.data().total]));
      arr.sort((a,b)=>b[1]-a[1]);
      arr.forEach(([name, score], idx)=>{
        const tr = document.createElement("tr");
        if(idx==0) tr.classList.add("gold");
        if(idx==1) tr.classList.add("silver");
        if(idx==2) tr.classList.add("bronze");
        tr.innerHTML=`<td>${idx+1}</td><td>${name}</td><td>${score.toFixed(1)}</td>`;
        rows.appendChild(tr);
      });
    }

    async function showDailyLeaderboard(){
      const today = new Date().toISOString().slice(0,10);
      const rows = document.querySelector("#dailyBoard tbody"); rows.innerHTML="";
      let arr = [];
      const snap = await getDocs(collection(db, `daily-${today}`));
      snap.forEach(d => arr.push([d.id, d.data().score]));
      arr.sort((a,b)=>b[1]-a[1]);
      arr.forEach(([name, score], idx)=>{
        const tr = document.createElement("tr");
        if(idx==0) tr.classList.add("gold");
        if(idx==1) tr.classList.add("silver");
        if(idx==2) tr.classList.add("bronze");
        tr.innerHTML=`<td>${idx+1}</td><td>${name}</td><td>${score.toFixed(1)}</td>`;
        rows.appendChild(tr);
      });
    }

    function login(){
      const u = document.getElementById("username").value.toLowerCase();
      const p = document.getElementById("password").value.toLowerCase();
      if(users[u]===p){
        currentUser=u;
        document.getElementById("loginBox").style.display="none";
        document.getElementById("gameBox").style.display="block";
        document.getElementById("playerName").innerText = u;
        showTotalLeaderboard();
        showDailyLeaderboard();
      } else document.getElementById("error").innerText="Wrong credentials!";
    }

    function startGame(){
      const diff = document.getElementById("difficulty").value;
      const gameArea = document.getElementById("gameArea");
      const scoreDisplay = document.getElementById("scoreDisplay");
      const timerDisplay = document.getElementById("timer");
      const playAgain = document.getElementById("playAgainBtn");

      gameArea.innerHTML=""; playAgain.style.display="none";
      let score=0, missed=0, sec=30;
      scoreDisplay.innerText="Score: 0";
      timerDisplay.innerText=`‚è≥ Time left: ${sec}s`;

      const ptsMap = {easy:1,medium:1.5,hard:2}[diff];
      const fallSpd = {easy:60,medium:40,hard:25}[diff];
      const rate = {easy:1000,medium:700,hard:400}[diff];

      const tI = setInterval(()=>{
        sec--; timerDisplay.innerText=`‚è≥ Time left: ${sec}s`;
        if(sec<=0){clearInterval(tI);clearInterval(pI);endGame();}
      },1000);

      function drop(){
        const pc = document.createElement("div"); pc.className="poop"; pc.textContent="üí©";
        pc.style.left=Math.random()*90+"%"; gameArea.appendChild(pc);
        let pos=0;
        const fI=setInterval(()=>{
          if(pos>=270){clearInterval(fI);pc.remove();missed++;
            if(missed>=3){clearInterval(tI);clearInterval(pI);endGame();}}
          else{pos+=5;pc.style.top=pos+"px";}
        },fallSpd);
        pc.onclick=()=>{
          clearInterval(fI);pc.remove();score+=ptsMap;scoreDisplay.innerText=`Score: ${score.toFixed(1)}`;
        };
      }

      const pI = setInterval(()=>{if(missed<3&&sec>0)drop();},rate);

      async function endGame(){
        alert(`Game Over! Score: ${score.toFixed(1)}`);
        gameArea.innerHTML=""; timerDisplay.innerText="";
        playAgain.style.display="inline-block";
        const now=new Date(), today=now.toISOString().slice(0,10);
        const uRef=doc(db,"scores",currentUser);
        const snap=await getDoc(uRef);
        const prev=snap.exists()?snap.data().total:0;
        await setDoc(uRef,{total:prev+score,lastPlayed:now.toISOString()});
        const dRef=doc(db,`daily-${today}`,currentUser);
        await setDoc(dRef,{score,time:now.toISOString()});
        showTotalLeaderboard(); showDailyLeaderboard();
      }
    }
  </script>
</head>
<body>
  <h1>üè∞ Welcome to Avigyan Kingdom üè∞</h1>
  <div id="loginBox">
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="error" style="color:red"></p>
  </div>
  <div id="gameBox" style="display:none">
    <h2>Welcome, <span id="playerName"></span>!</h2>
    <p>üéØ Task: Tap falling poops!</p>
    <select id="difficulty">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select><button onclick="startGame()">Start Game</button>
    <div id="timer"></div>
    <div id="scoreDisplay">Score: 0</div>
    <div id="gameArea"></div>
    <button id="playAgainBtn" onclick="startGame()">Play Again</button>
    <h3>üèÜ All-Time Leaderboard</h3>
    <table class="leaderboard-table" id="totalBoard"><thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead><tbody></tbody></table>
    <h3>üéâ Today's Top Scorer</h3>
    <table class="leaderboard-table" id="dailyBoard"><thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead><tbody></tbody></table>
  </div>
</body>
</html>
